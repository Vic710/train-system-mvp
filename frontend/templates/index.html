<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Section Controller - Decision Engine</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid #4CAF50;
        }

        .header h1 {
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 i {
            color: #4CAF50;
        }

        .header p {
            color: #7f8c8d;
            margin-top: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-status {
            display: grid;
            gap: 1rem;
        }

        .section-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #4CAF50;
            transition: transform 0.2s;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .section-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 500;
        }

        .status-normal { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-danger { background: #f8d7da; color: #721c24; }

        .train-counts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .train-count {
            text-align: center;
            padding: 0.5rem;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .count-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .count-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .decision-panel {
            display: grid;
            gap: 1rem;
        }

        .scenario-selector {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #2c3e50;
        }

        .form-control {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .predefined-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .scenario-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }

        .scenario-card.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .scenario-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .scenario-description {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .analysis-result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .analysis-title {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .analysis-timestamp {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .ai-suggestion {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin: 1rem 0;
        }

        .ai-suggestion h3 {
            color: #28a745;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .suggestion-content {
            line-height: 1.6;
            color: #2c3e50;
        }

        .context-summary {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #6f42c1;
        }

        .controller-decision {
            background: #e7f3ff;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #0056b3;
            margin-top: 1rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .scenario-selector {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-train"></i> Railway Section Controller Decision Engine</h1>
        <p>AI-Powered Railway Operations Management System</p>
    </div>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Section Status Panel -->
            <div class="card">
                <h2><i class="fas fa-tachometer-alt"></i> Section Status</h2>
                <div id="sectionStatus" class="section-status">
                    <div class="loading show">
                        <div class="spinner"></div>
                        <p>Loading section data...</p>
                    </div>
                </div>
            </div>

            <!-- Decision Analysis Panel -->
            <div class="card">
                <h2><i class="fas fa-brain"></i> Decision Analysis</h2>
                
                <div class="scenario-selector">
                    <div class="form-group">
                        <label for="sectionSelect">Select Section:</label>
                        <select id="sectionSelect" class="form-control">
                            <option value="">Loading sections...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button id="loadPredefinedBtn" class="btn btn-secondary">
                            <i class="fas fa-list"></i> Load Scenarios
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="issueDescription">Describe the Issue/Situation:</label>
                    <textarea id="issueDescription" class="form-control" 
                             placeholder="e.g., Train engine failure on main line, signal malfunction, crew fatigue..."></textarea>
                </div>

                <button id="analyzeBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> Analyze Decision
                </button>

                <div id="predefinedScenarios" class="predefined-scenarios" style="display: none;">
                    <!-- Predefined scenarios will be loaded here -->
                </div>

                <div id="analysisResult" class="analysis-result" style="display: none;">
                    <!-- Analysis results will be shown here -->
                </div>

                <div id="loadingAnalysis" class="loading">
                    <div class="spinner"></div>
                    <p>AI analyzing situation...</p>
                </div>
            </div>
        </div>

        <!-- Historical Decisions -->
        <div class="card">
            <h2><i class="fas fa-history"></i> Recent Decisions</h2>
            <div id="decisionHistory">
                <div class="loading show">
                    <div class="spinner"></div>
                    <p>Loading decision history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sections = [];
        let predefinedScenarios = [];
        let currentAnalysis = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSections();
            loadDecisionHistory();
            loadPredefinedScenarios();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('analyzeBtn').addEventListener('click', analyzeDecision);
            document.getElementById('loadPredefinedBtn').addEventListener('click', togglePredefinedScenarios);
        }

        async function loadSections() {
            try {
                const response = await fetch('/api/sections');
                sections = await response.json();
                
                displaySections();
                populateSectionSelect();
            } catch (error) {
                console.error('Error loading sections:', error);
                document.getElementById('sectionStatus').innerHTML = 
                    '<div class="alert alert-danger">Error loading section data</div>';
            }
        }

        function displaySections() {
            const container = document.getElementById('sectionStatus');
            container.innerHTML = '';

            sections.forEach(section => {
                const sectionCard = document.createElement('div');
                sectionCard.className = 'section-card';
                
                const statusClass = getStatusClass(section);
                sectionCard.style.borderLeftColor = getStatusColor(section);

                sectionCard.innerHTML = `
                    <div class="section-header">
                        <div class="section-name">${section.name}</div>
                    </div>
                    
                    <div class="status-indicators">
                        <div class="status-badge ${getBlockStatusClass(section.block_status)}">
                            ${section.block_status}
                        </div>
                        <div class="status-badge ${getPowerStatusClass(section.power_status)}">
                            ${section.power_status}
                        </div>
                        <div class="status-badge ${getSignalStatusClass(section.signal_status)}">
                            ${section.signal_status}
                        </div>
                        <div class="status-badge ${getWeatherStatusClass(section.weather_condition)}">
                            ${section.weather_condition}
                        </div>
                    </div>

                    <div class="train-counts">
                        <div class="train-count">
                            <div class="count-number">${section.train_counts.on_time}</div>
                            <div class="count-label">On Time</div>
                        </div>
                        <div class="train-count">
                            <div class="count-number">${section.train_counts.delayed}</div>
                            <div class="count-label">Delayed</div>
                        </div>
                        <div class="train-count">
                            <div class="count-number">${section.train_counts.halted}</div>
                            <div class="count-label">Halted</div>
                        </div>
                        <div class="train-count">
                            <div class="count-number">${section.train_counts.total}</div>
                            <div class="count-label">Total</div>
                        </div>
                    </div>
                `;

                container.appendChild(sectionCard);
            });
        }

        function populateSectionSelect() {
            const select = document.getElementById('sectionSelect');
            select.innerHTML = '<option value="">Select a section...</option>';
            
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.name;
                select.appendChild(option);
            });
        }

        async function loadPredefinedScenarios() {
            try {
                const response = await fetch('/api/scenarios/predefined');
                predefinedScenarios = await response.json();
            } catch (error) {
                console.error('Error loading scenarios:', error);
            }
        }

        function togglePredefinedScenarios() {
            const container = document.getElementById('predefinedScenarios');
            const isVisible = container.style.display !== 'none';
            
            if (isVisible) {
                container.style.display = 'none';
                document.getElementById('loadPredefinedBtn').innerHTML = 
                    '<i class="fas fa-list"></i> Load Scenarios';
            } else {
                displayPredefinedScenarios();
                container.style.display = 'block';
                document.getElementById('loadPredefinedBtn').innerHTML = 
                    '<i class="fas fa-times"></i> Hide Scenarios';
            }
        }

        function displayPredefinedScenarios() {
            const container = document.getElementById('predefinedScenarios');
            container.innerHTML = '';

            predefinedScenarios.forEach(scenario => {
                const scenarioCard = document.createElement('div');
                scenarioCard.className = 'scenario-card';
                scenarioCard.innerHTML = `
                    <div class="scenario-title">${scenario.name}</div>
                    <div class="scenario-description">${scenario.description}</div>
                `;

                scenarioCard.addEventListener('click', () => {
                    // Clear previous selection
                    container.querySelectorAll('.scenario-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    // Select this scenario
                    scenarioCard.classList.add('selected');
                    
                    // Fill the form
                    document.getElementById('sectionSelect').value = scenario.section_id;
                    document.getElementById('issueDescription').value = scenario.description;
                });

                container.appendChild(scenarioCard);
            });
        }

        async function analyzeDecision() {
            const sectionId = document.getElementById('sectionSelect').value;
            const issueDescription = document.getElementById('issueDescription').value;

            if (!sectionId || !issueDescription) {
                alert('Please select a section and describe the issue.');
                return;
            }

            // Show loading
            document.getElementById('loadingAnalysis').classList.add('show');
            document.getElementById('analysisResult').style.display = 'none';

            try {
                const response = await fetch('/api/decision/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: parseInt(sectionId),
                        issue_description: issueDescription
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentAnalysis = result.analysis;
                    displayAnalysisResult(result.analysis);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error analyzing decision:', error);
                document.getElementById('analysisResult').innerHTML = 
                    '<div class="alert alert-danger">Error analyzing decision: ' + error.message + '</div>';
                document.getElementById('analysisResult').style.display = 'block';
            } finally {
                document.getElementById('loadingAnalysis').classList.remove('show');
            }
        }

        function displayAnalysisResult(analysis) {
            const container = document.getElementById('analysisResult');
            
            const timestamp = new Date(analysis.timestamp).toLocaleString();
            const sectionName = sections.find(s => s.id === analysis.section_id)?.name || 'Unknown Section';

            container.innerHTML = `
                <div class="analysis-header">
                    <div class="analysis-title">Decision Analysis - ${sectionName}</div>
                    <div class="analysis-timestamp">${timestamp}</div>
                </div>

                <div class="context-summary">
                    <h3><i class="fas fa-info-circle"></i> Issue Description</h3>
                    <p>${analysis.issue_description}</p>
                </div>

                <div class="ai-suggestion">
                    <h3><i class="fas fa-robot"></i> AI Recommendation</h3>
                    <div class="suggestion-content">
                        ${formatAISuggestion(analysis.ai_suggestion)}
                    </div>
                </div>

                <div class="controller-decision">
                    <h3><i class="fas fa-user"></i> Controller Decision</h3>
                    <div class="form-group">
                        <label for="controllerAction">Your Decision:</label>
                        <textarea id="controllerAction" class="form-control" 
                                 placeholder="Enter your final decision as the section controller..."></textarea>
                    </div>
                    <button onclick="storeControllerDecision()" class="btn btn-primary">
                        <i class="fas fa-save"></i> Store Decision
                    </button>
                </div>
            `;

            container.style.display = 'block';
        }

        function formatAISuggestion(suggestion) {
            // Convert markdown-style formatting to HTML
            return suggestion
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        async function storeControllerDecision() {
            const controllerAction = document.getElementById('controllerAction').value;
            
            if (!controllerAction || !currentAnalysis) {
                alert('Please enter your decision.');
                return;
            }

            try {
                const response = await fetch('/api/decision/store', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: currentAnalysis.section_id,
                        controller_action: controllerAction,
                        outcome: 'Resolved' // Default outcome
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'alert alert-success';
                    successMsg.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        Decision stored successfully! (ID: ${result.decision_id})
                        This decision will be used for future AI training.
                    `;
                    
                    document.getElementById('analysisResult').appendChild(successMsg);
                    
                    // Refresh decision history
                    loadDecisionHistory();
                    
                    // Clear the form
                    document.getElementById('controllerAction').value = '';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error storing decision:', error);
                alert('Error storing decision: ' + error.message);
            }
        }

        async function loadDecisionHistory() {
            try {
                const response = await fetch('/api/decisions/history');
                const decisions = await response.json();
                
                displayDecisionHistory(decisions);
            } catch (error) {
                console.error('Error loading decision history:', error);
                document.getElementById('decisionHistory').innerHTML = 
                    '<div class="alert alert-danger">Error loading decision history</div>';
            }
        }

        function displayDecisionHistory(decisions) {
            const container = document.getElementById('decisionHistory');
            
            if (decisions.length === 0) {
                container.innerHTML = '<p>No decisions recorded yet.</p>';
                return;
            }

            container.innerHTML = decisions.map(decision => {
                const timestamp = new Date(decision.timestamp).toLocaleString();
                return `
                    <div class="decision-history-item" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #17a2b8;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>${decision.section_name}</strong>
                            <span style="color: #6c757d; font-size: 0.9rem;">${timestamp}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">${decision.controller_action}</div>
                        <div style="font-size: 0.9rem;">
                            <span class="status-badge ${getOutcomeStatusClass(decision.outcome)}">${decision.outcome}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Utility functions for status styling
        function getStatusClass(section) {
            if (section.block_status !== 'Free' || section.power_status !== 'Normal' || section.signal_status !== 'Normal') {
                return 'status-warning';
            }
            return 'status-normal';
        }

        function getStatusColor(section) {
            if (section.block_status !== 'Free' || section.power_status !== 'Normal' || section.signal_status !== 'Normal') {
                return '#ffc107';
            }
            return '#28a745';
        }

        function getBlockStatusClass(status) {
            return status === 'Free' ? 'status-normal' : 'status-warning';
        }

        function getPowerStatusClass(status) {
            return status === 'Normal' ? 'status-normal' : 'status-danger';
        }

        function getSignalStatusClass(status) {
            return status === 'Normal' ? 'status-normal' : 'status-danger';
        }

        function getWeatherStatusClass(status) {
            return status === 'Clear' ? 'status-normal' : 'status-warning';
        }

        function getOutcomeStatusClass(outcome) {
            switch(outcome) {
                case 'Resolved': return 'status-normal';
                case 'Partially Resolved': return 'status-warning';
                case 'Escalated': return 'status-danger';
                default: return 'status-normal';
            }
        }

        // Auto-refresh section status every 30 seconds
        setInterval(loadSections, 30000);
    </script>
</body>
</html>
